<!DOCTYPE html>
<html lang="{{ lang if lang else 'en' }}">  <!-- ✅ CORREGIDO: Sintaxis Nunjucks -->
<head>
  <meta charset="UTF-8">
  <title>{% block title %}Solidarity{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Plataforma colaborativa para impulsar la solidaridad y el impacto social">
  
  <!-- Favicon -->
  <link rel="icon" href="/images/favicon.ico" type="image/x-icon">
  
  <!-- CSS -->
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  {% block head %}{% endblock %}
</head>
<body class="{{ bodyClass if bodyClass else ('lang-' + (lang if lang else 'en')) }}">  <!-- ✅ CORREGIDO -->
  <!-- Navbar -->
  <header>
    {% include "partials/navbar.njk" %}
    {% include "partials/language-selector.njk" %}
  </header>

  <!-- Contenido principal -->
  <main class="main-content">
    {% block content %}{% endblock %}
  </main>

  <!-- Footer -->
  {% include "partials/footer.njk" %}

  <!-- ✅ SCRIPTS BASE - ORDEN CORRECTO -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = 'https://cyftasxlrzuynzbrfgkd.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5ZnRhc3hscnp1eW56YnJmZ2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMzUzMTksImV4cCI6MjA2MzYxMTMxOX0.I56ZqFTfLgdwWlcozMVncGNGBZ4A2_5VpAbHeNmtDhA';
    const supabase = window.supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    
    // ✅ IDIOMA DISPONIBLE GLOBALMENTE
    window.currentLang = '{{ lang if lang else "en" }}';  <!-- ✅ CORREGIDO -->
  </script>
  
  <!-- ✅ SISTEMA DE TRADUCCIONES MEJORADO -->
  <script src="/js/i18n.js"></script>
  
  <!-- ✅ SELECTOR DE IDIOMAS -->
  <script src="/js/components/languageselector.js"></script>
  
  <!-- ✅ OTROS SCRIPTS -->
  <script src="/js/navbar.js"></script>
  <script src="/js/impactpoints.js"></script>

  {% block scripts %}{% endblock %}

  <!-- Notificaciones -->
  <div id="notifications" class="notifications-container"></div>

  <!-- Modal de bienvenida -->
  <div id="welcomeModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:18px; max-width:370px; margin:auto; padding:2.2rem 1.7rem; box-shadow:0 8px 32px rgba(0,0,0,0.13); text-align:center;">
      <span style="font-size:2.7rem; color:#2dd4bf; display:block; margin-bottom:1rem;">
        <i class="fas fa-fire"></i>
      </span>
      <h2 style="color:#2dd4bf; font-weight:900; margin-bottom:0.7rem;" data-i18n="welcome.title">¡Bienvenido/a de nuevo!</h2>
      <p style="color:#444; font-size:1.13rem;" data-i18n="welcome.message">
        ¡Nos alegra verte en Solidarity!<br>
        <strong>Hoy es un gran día para ayudar, inspirar y transformar el mundo.</strong>
      </p>
      <p style="color:#888; font-size:0.97rem; margin-top:1em;" data-i18n="welcome.subtitle">
        ¿Listo/a para dejar tu huella positiva?<br>
        ¡Explora, conecta y actúa!
      </p>
      <button onclick="document.getElementById('welcomeModal').style.display='none';" 
              style="margin-top:1.5rem; background:#2dd4bf; color:#fff; border:none; border-radius:8px; padding:0.8rem 1.7rem; font-size:1.1rem; font-weight:700; cursor:pointer;" 
              data-i18n="welcome.button">
        ¡Vamos allá!
      </button>
    </div>
  </div>
  
  <!-- ✅ SCRIPT PARA TRADUCIR AUTOMÁTICAMENTE -->
  <script>
    // Traducir elementos cuando i18n esté listo
    document.addEventListener('i18nReady', () => {
      translateElements();
    });

    // Función para actividades trending
    function isTrending(activity) {
      if (activity.type === 'cause') {
        return (activity.beneficiaries || 0) + (activity.raised || 0) > 100;
      }
      if (activity.type === 'task') {
        return (activity.beneficiaries || 0) > 50;
      }
      if (activity.type === 'volunteering') {
        return (activity.volunteers_needed || 0) > 30;
      }
      if (activity.type === 'challenge') {
        const created = new Date(activity.created_at);
        const now = new Date();
        const diffDays = (now - created) / (1000 * 60 * 60 * 24);
        return diffDays < 7;
      }
      return false;
    }
  </script>

  <!-- Scripts antes del cierre del body -->
  <script src="/js/compartir.js"></script>

  <!-- Mobile Navigation Components -->
  <script src="/js/components/mobile-bottom-nav.js"></script>
  <solidarity-bottom-nav></solidarity-bottom-nav>

  <script src="/js/components/mobile-hamburger-menu.js"></script>
  <script src="/js/components/mobile-header.js"></script>
  <script src="/js/components/mobile-avatar.js"></script>

  <solidarity-mobile-header>
    <solidarity-hamburger-menu slot="hamburger"></solidarity-hamburger-menu>
    <solidarity-mobile-avatar slot="avatar"></solidarity-mobile-avatar>
  </solidarity-mobile-header>

</body>
</html>